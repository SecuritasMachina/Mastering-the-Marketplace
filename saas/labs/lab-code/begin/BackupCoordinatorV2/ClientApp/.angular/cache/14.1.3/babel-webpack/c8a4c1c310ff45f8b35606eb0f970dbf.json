{"ast":null,"code":"import _asyncToGenerator from \"C:/data/source/Mastering-the-Marketplace/saas/labs/lab-code/begin/BackupCoordinatorV2/ClientApp/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { environment } from '../../../environments/environment';\nimport { GlobalConstModule } from '../../Common/global-const/global-const.module';\nvar dirListingDTO = [];\nexport class DirListingComponent {\n  //public restoreInProgress: boolean | undefined;\n  // const options = new RequestOptions({ headers: this.headers });\n  constructor(http, _Activatedroute, toastr) {\n    this._Activatedroute = _Activatedroute;\n    this.toastr = toastr;\n    this.genericMsg = {};\n    this.headers = new Headers({\n      'Accept': 'application/json',\n      'enctype': 'multipart/form-data'\n    });\n    this.timerCount = 0;\n    this.tmp = [];\n    this._http = http;\n    console.info('environment.appServerURL', environment.appServerURL);\n  }\n\n  ngOnInit() {\n    this._guid = this._Activatedroute.snapshot.paramMap.get(\"guid\");\n    console.info(\"DirListingComponent GlobalConstModule.guid1\", GlobalConstModule.guid);\n    console.log(\"this._guid\", this._guid);\n    new Timer(this._http, dirListingDTO, this._guid, this.syncDirList()).doTimer();\n  }\n\n  syncDirList() {\n    var ret;\n    console.info(' syncDirList');\n    return ret;\n  }\n\n  CheckBackupStatus(pRestoreFileName, pTimerCount) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      var pGuid = _this._guid; //throw new Error('Function not implemented.');\n\n      console.info(' pRestoreFileName', pRestoreFileName); //this.httpCall(\"POST\", pRestoreFileName)\n\n      _this._http.get(environment.appServerURL + \"/api/v3/getCache/\" + encodeURIComponent(pRestoreFileName + \"-restoreComplete-\" + pGuid)).subscribe(result => {\n        console.log(\"getCache response:\", result); //result.\n        //console.log(\"getCache this.tmp[pTimerCount]:\", this.tmp[pTimerCount], pTimerCount);\n\n        clearInterval(_this.tmp[pTimerCount]); //clearTimeout(this.tmp[pTimerCount]);\n        //this.tmp[pTimerCount] = null;\n\n        dirListingDTO.forEach((obj, index) => {\n          if (pRestoreFileName == obj.FileName || encodeURI(pRestoreFileName) == encodeURIComponent(obj.FileName)) {\n            obj.disabled = false;\n          }\n        });\n\n        _this.toastr.success(pRestoreFileName + ' restored', 'Restore Status');\n\n        _this._http.get(environment.appServerURL + \"/api/v3/deleteCache/\" + encodeURIComponent(pRestoreFileName + \"-restoreComplete-\" + pGuid)).subscribe(result => {\n          console.log(\"deleteCache response:\", result);\n        });\n\n        return false;\n      }, error => {\n        if (error.status != 404) console.log(\"error response:\", error);\n      });\n\n      return true;\n    })();\n  }\n\n  restoreFile(pItem) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      console.info('restoreFile.pRestoreFileName', pItem.FileName); //pItem.disabled = true;\n\n      const response = yield fetch(environment.appServerURL + \"/api/v2/requestRestore/\" + _this2._guid, {\n        method: 'POST',\n        body: JSON.stringify({\n          backupName: pItem.FileName,\n          customerGUID: _this2._guid\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n          Accept: 'application/json'\n        }\n      });\n\n      _this2.toastr.success(pItem.FileName + ' submitted for restoration', 'Restore Status');\n\n      if (!response.ok) {\n        throw new Error(`Error! status: ${response.status}`);\n      }\n\n      _this2.timerCount++;\n      var timedID = _this2.timerCount;\n      _this2.tmp[timedID] = setInterval(() => {\n        _this2.CheckBackupStatus(pItem.FileName, timedID);\n      }, 10 * 1000);\n    })();\n  }\n\n}\n\nfunction delay(delay) {\n  return new Promise(r => {\n    setTimeout(r, delay);\n  });\n}\n\nclass Timer {\n  constructor(_http, dirListingDTO, _guid, callback) {\n    this._http = _http;\n    this.dirListingDTO = dirListingDTO;\n    this._guid = _guid;\n    this.callback = callback;\n    this.doTimer();\n  }\n\n  doTimer() {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      while (true) {\n        yield delay(10 * 1000);\n\n        _this3._http.get(environment.appServerURL + '/api/v3/getCache/dirListing-' + _this3._guid).subscribe(result => {\n          //this.genericMsg.msg = result.msg;\n          //  this.genericMsg.guid = result.guid;\n          var tmp1 = JSON.parse(result.msg);\n          _this3.dirListingDTO = [];\n          tmp1.fileDTOs.forEach((obj, index) => {\n            var fileDTO = {};\n            fileDTO.FileName = obj.FileName;\n            fileDTO.length = obj.length;\n            fileDTO.FileDate = obj.FileDate;\n            fileDTO.disabled = false;\n\n            _this3.dirListingDTO.push(fileDTO);\n          });\n          _this3.callback?.arguments;\n          _this3.callback?.call(delay);\n          dirListingDTO = _this3.dirListingDTO; //console.info(' this.dirListingDTO', this.dirListingDTO);\n        }, error => console.error(error)); //  console.log(this.counter);\n\n      }\n    })();\n  }\n\n}","map":{"version":3,"mappings":"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","names":["environment","GlobalConstModule","dirListingDTO","DirListingComponent","constructor","http","_Activatedroute","toastr","Headers","_http","console","info","appServerURL","ngOnInit","_guid","snapshot","paramMap","get","guid","log","Timer","syncDirList","doTimer","ret","CheckBackupStatus","pRestoreFileName","pTimerCount","pGuid","encodeURIComponent","subscribe","result","clearInterval","tmp","forEach","obj","index","FileName","encodeURI","disabled","success","error","status","restoreFile","pItem","response","fetch","method","body","JSON","stringify","backupName","customerGUID","headers","Accept","ok","Error","timerCount","timedID","setInterval","delay","Promise","r","setTimeout","callback","tmp1","parse","msg","fileDTOs","fileDTO","length","FileDate","push","arguments","call"],"sourceRoot":"","sources":["C:\\data\\source\\Mastering-the-Marketplace\\saas\\labs\\lab-code\\begin\\BackupCoordinatorV2\\ClientApp\\src\\app\\Components\\dir-listing\\dir-listing.component.ts"],"sourcesContent":["import { Component, OnInit, Inject } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { environment } from '../../../environments/environment';\r\nimport { ActivatedRoute } from '@angular/router'\r\nimport { GlobalConstModule } from '../../Common/global-const/global-const.module';\r\nimport { NotificationService } from '../../Services/notification.service';\r\n//import { NavMenuComponent } from '../../nav-menu/nav-menu.component';\r\nimport { ToastrService } from 'ngx-toastr';\r\n@Component({\r\n  selector: 'app-dir-listing',\r\n  templateUrl: './dir-listing.component.html',\r\n  styleUrls: ['./dir-listing.component.css']\r\n})\r\nvar dirListingDTO: DirListingDTO[] = [];\r\nexport class DirListingComponent implements OnInit {\r\n\r\n  \r\n  public genericMsg = {} as GenericMsg2;\r\n  private headers = new Headers({\r\n    'Accept': 'application/json',\r\n    'enctype': 'multipart/form-data'\r\n  });\r\n\r\n  public _guid: string | null | undefined;\r\n  _http: HttpClient;\r\n\r\n  private timerCount = 0;\r\n  private tmp: any = [];\r\n  //public restoreInProgress: boolean | undefined;\r\n  // const options = new RequestOptions({ headers: this.headers });\r\n\r\n  constructor(http: HttpClient, private _Activatedroute: ActivatedRoute, private toastr: ToastrService) {\r\n\r\n    this._http = http;\r\n    console.info('environment.appServerURL', environment.appServerURL);\r\n\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    this._guid = this._Activatedroute.snapshot.paramMap.get(\"guid\");\r\n    console.info(\"DirListingComponent GlobalConstModule.guid1\", GlobalConstModule.guid);\r\n    console.log(\"this._guid\", this._guid);\r\n    new Timer(this._http, dirListingDTO, this._guid, this.syncDirList()).doTimer();\r\n\r\n  }\r\n  syncDirList(): Function | undefined {\r\n    var ret: any;\r\n    console.info(' syncDirList');\r\n    return ret;\r\n  }\r\n  async CheckBackupStatus(pRestoreFileName: string, pTimerCount: number) {\r\n    var pGuid = this._guid;\r\n    //throw new Error('Function not implemented.');\r\n    console.info(' pRestoreFileName', pRestoreFileName);\r\n    //this.httpCall(\"POST\", pRestoreFileName)\r\n    this._http.get<GenericMsg>(environment.appServerURL + \"/api/v3/getCache/\" + encodeURIComponent(pRestoreFileName + \"-restoreComplete-\" + pGuid)).subscribe(result => {\r\n      console.log(\"getCache response:\", result);\r\n      //result.\r\n      //console.log(\"getCache this.tmp[pTimerCount]:\", this.tmp[pTimerCount], pTimerCount);\r\n      clearInterval(this.tmp[pTimerCount]);\r\n      //clearTimeout(this.tmp[pTimerCount]);\r\n      //this.tmp[pTimerCount] = null;\r\n\r\n\r\n      dirListingDTO.forEach((obj: DirListingDTO, index: any) => {\r\n        if (pRestoreFileName == obj.FileName || encodeURI(pRestoreFileName) == encodeURIComponent(obj.FileName)) {\r\n          obj.disabled = false;\r\n        }\r\n      });\r\n      this.toastr.success(pRestoreFileName + ' restored', 'Restore Status');\r\n      this._http.get<string>(environment.appServerURL + \"/api/v3/deleteCache/\" + encodeURIComponent(pRestoreFileName + \"-restoreComplete-\" + pGuid)).subscribe(result => {\r\n        console.log(\"deleteCache response:\", result);\r\n      });\r\n      return false;\r\n    }, error => {\r\n      if (error.status != 404)\r\n        console.log(\"error response:\", error);\r\n    });\r\n\r\n    return true;\r\n  }\r\n  async restoreFile(pItem: DirListingDTO): Promise<void> {\r\n    console.info('restoreFile.pRestoreFileName', pItem.FileName);\r\n\r\n    //pItem.disabled = true;\r\n\r\n    const response = await fetch(environment.appServerURL + \"/api/v2/requestRestore/\" + this._guid, {\r\n      method: 'POST',\r\n      body: JSON.stringify({\r\n        backupName: pItem.FileName,\r\n        customerGUID: this._guid,\r\n      }),\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Accept: 'application/json',\r\n      },\r\n    });\r\n    this.toastr.success(pItem.FileName + ' submitted for restoration', 'Restore Status');\r\n    if (!response.ok) {\r\n      throw new Error(`Error! status: ${response.status}`);\r\n    }\r\n    this.timerCount++;\r\n    var timedID: number = this.timerCount;\r\n    this.tmp[timedID] = setInterval(() => {\r\n      this.CheckBackupStatus(pItem.FileName, timedID);\r\n    }, 10 * 1000);\r\n  }\r\n}\r\ntype GenericMsg2 = {\r\n  msgType: string;\r\n  msg: string;\r\n  guid: string;\r\n}\r\ninterface GenericMsg {\r\n  msgType: string;\r\n  msg: string;\r\n  guid: string;\r\n}\r\ninterface DirListingDTO {\r\n  FileName: string;\r\n  length: number;\r\n  date: string;\r\n  FileDate: number;\r\n  disabled: boolean;\r\n}\r\nfunction delay(delay: number) {\r\n  return new Promise(r => {\r\n    setTimeout(r, delay);\r\n  })\r\n}\r\n\r\nclass Timer {\r\n  constructor(private _http: HttpClient, public dirListingDTO: DirListingDTO[], private _guid: string | null, private callback?: Function) {\r\n    this.doTimer();\r\n  }\r\n  async doTimer() {\r\n    while (true) {\r\n      await delay(10 * 1000);\r\n\r\n      this._http.get<GenericMsg>(environment.appServerURL + '/api/v3/getCache/dirListing-' + this._guid).subscribe(result => {\r\n\r\n        //this.genericMsg.msg = result.msg;\r\n        //  this.genericMsg.guid = result.guid;\r\n\r\n\r\n        var tmp1 = JSON.parse(result.msg);\r\n        this.dirListingDTO = [];\r\n        tmp1.fileDTOs.forEach((obj: any, index: any) => {\r\n\r\n          var fileDTO = {} as DirListingDTO;\r\n          fileDTO.FileName = obj.FileName;\r\n          fileDTO.length = obj.length;\r\n          fileDTO.FileDate = obj.FileDate;\r\n          fileDTO.disabled = false;\r\n          this.dirListingDTO.push(fileDTO);\r\n\r\n        });\r\n        this.callback?.arguments\r\n        this.callback?.call(delay);\r\n        dirListingDTO = this.dirListingDTO ;\r\n        //console.info(' this.dirListingDTO', this.dirListingDTO);\r\n\r\n      }, (error: any) => console.error(error));\r\n\r\n      //  console.log(this.counter);\r\n    }\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}